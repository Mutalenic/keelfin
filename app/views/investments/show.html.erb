<nav class="flex justify-center align-center space-x-4 bg-[#3778c2] text-white">
  <ul class="w-full flex flex-row justify-between align-center p-5">
    <li>
      <%= link_to '', investments_path, class: "text-xl fa-solid fa-arrow-left" %>
    </li>
    <li>
      <h1 class="text-xl uppercase">Investment Details</h1>
    </li>
    <li>
      <%= link_to '', edit_investment_path(@investment), class: "text-xl fa-solid fa-pencil" %>
    </li>
  </ul>
</nav>

<div class="container mx-auto px-4 py-6">
  <!-- Investment Header -->
  <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
    <div class="flex justify-between items-start">
      <div>
        <h1 class="text-2xl font-bold mb-2"><%= @investment.name %></h1>
        <div class="mt-3 flex flex-wrap gap-2">
          <span class="inline-block px-3 py-1 rounded-full text-sm font-semibold bg-blue-100 text-blue-800">
            <%= @investment.investment_type_text %>
          </span>
          <% if @investment.risk_level %>
            <span class="inline-block px-3 py-1 rounded-full text-sm font-semibold 
              <%= case @investment.risk_level
                  when 1 then 'bg-green-100 text-green-800'
                  when 2 then 'bg-blue-100 text-blue-800'
                  when 3 then 'bg-yellow-100 text-yellow-800'
                  when 4 then 'bg-orange-100 text-orange-800'
                  when 5 then 'bg-red-100 text-red-800'
                  end %>">
              <%= @investment.risk_level_text %> Risk
            </span>
          <% end %>
          <% if @investment.institution.present? %>
            <span class="inline-block px-3 py-1 rounded-full text-sm font-semibold bg-gray-100 text-gray-800">
              <%= @investment.institution %>
            </span>
          <% end %>
        </div>
      </div>
      <div class="text-right">
        <% if @investment.active? %>
          <span class="inline-block px-4 py-2 rounded-lg text-sm font-bold bg-green-100 text-green-800">
            Active
          </span>
        <% else %>
          <span class="inline-block px-4 py-2 rounded-lg text-sm font-bold bg-gray-100 text-gray-800">
            Inactive
          </span>
        <% end %>
      </div>
    </div>
  </div>

  <!-- Current Value and Performance -->
  <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
    <!-- Current Value -->
    <div class="bg-white rounded-lg shadow-lg p-6">
      <h2 class="text-lg font-semibold mb-4">Current Value</h2>
      
      <div class="flex items-center justify-between mb-6">
        <div>
          <p class="text-3xl font-bold">K<%= number_with_precision(@investment.current_value, precision: 2) %></p>
          <% if @investment.last_updated %>
            <p class="text-xs text-gray-500 mt-1">Last updated: <%= @investment.last_updated.strftime('%b %d, %Y') %></p>
          <% end %>
        </div>
        
        <div class="text-right">
          <% performance_trend = @investment.performance_trend %>
          <% if performance_trend == 'positive' %>
            <div class="text-green-600">
              <i class="fa-solid fa-arrow-trend-up text-3xl"></i>
            </div>
          <% elsif performance_trend == 'negative' %>
            <div class="text-red-600">
              <i class="fa-solid fa-arrow-trend-down text-3xl"></i>
            </div>
          <% else %>
            <div class="text-gray-600">
              <i class="fa-solid fa-minus text-3xl"></i>
            </div>
          <% end %>
        </div>
      </div>
      
      <!-- Update Value Form -->
      <%= form_with url: update_value_investment_path(@investment), method: :patch, class: "mt-4" do |f| %>
        <div class="flex items-end space-x-2">
          <div class="flex-grow">
            <%= f.label :current_value, "Update Current Value", class: "block text-sm font-medium text-gray-700 mb-1" %>
            <div class="mt-1 flex rounded-md shadow-sm">
              <span class="inline-flex items-center px-3 rounded-l-md border border-r-0 border-gray-300 bg-gray-50 text-gray-500">K</span>
              <%= f.number_field :current_value, value: @investment.current_value, step: "0.01", min: "0", class: "flex-1 min-w-0 block w-full px-3 py-2 rounded-none rounded-r-md border border-gray-300 focus:ring-blue-500 focus:border-blue-500" %>
            </div>
          </div>
          <%= f.submit "Update", class: "bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700" %>
        </div>
      <% end %>
    </div>
    
    <!-- Performance Metrics -->
    <div class="bg-white rounded-lg shadow-lg p-6">
      <h2 class="text-lg font-semibold mb-4">Performance</h2>
      
      <div class="grid grid-cols-2 gap-4">
        <div>
          <p class="text-sm text-gray-600">Initial Investment</p>
          <p class="text-lg font-bold">K<%= number_with_precision(@investment.initial_amount, precision: 2) %></p>
        </div>
        
        <div>
          <p class="text-sm text-gray-600">Total Return</p>
          <p class="text-lg font-bold <%= @total_return >= 0 ? 'text-green-600' : 'text-red-600' %>">
            <%= @total_return >= 0 ? '+' : '' %>K<%= number_with_precision(@total_return, precision: 2) %>
          </p>
        </div>
        
        <div>
          <p class="text-sm text-gray-600">Return Percentage</p>
          <p class="text-lg font-bold <%= @return_percentage >= 0 ? 'text-green-600' : 'text-red-600' %>">
            <%= @return_percentage >= 0 ? '+' : '' %><%= number_with_precision(@return_percentage, precision: 2) %>%
          </p>
        </div>
        
        <div>
          <p class="text-sm text-gray-600">Annualized Return</p>
          <p class="text-lg font-bold <%= @annualized_return >= 0 ? 'text-green-600' : 'text-red-600' %>">
            <%= @annualized_return >= 0 ? '+' : '' %><%= number_with_precision(@annualized_return, precision: 2) %>%
          </p>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Value History Chart -->
  <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
    <h2 class="text-lg font-semibold mb-4">Value History</h2>
    
    <% if @value_history.any? %>
      <div class="h-64">
        <canvas id="value-history-chart"></canvas>
      </div>
      
      <script>
        // Make value history data available to the charts.js script
        const valueHistoryData = <%= raw @value_history.to_json %>;
      </script>
      
      <div class="mt-4 overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Value</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Change</th>
            </tr>
          </thead>
          <tbody class="bg-white divide-y divide-gray-200">
            <% previous_value = nil %>
            <% @value_history.reverse.each do |entry| %>
              <tr>
                <td class="px-6 py-4 whitespace-nowrap">
                  <div class="text-sm text-gray-900"><%= Date.parse(entry['date']).strftime('%b %d, %Y') %></div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                  <div class="text-sm font-medium">K<%= number_with_precision(entry['value'], precision: 2) %></div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                  <% if previous_value %>
                    <% change = entry['value'] - previous_value %>
                    <% change_percentage = previous_value > 0 ? (change / previous_value * 100).round(2) : 0 %>
                    <div class="text-sm font-medium <%= change >= 0 ? 'text-green-600' : 'text-red-600' %>">
                      <%= change >= 0 ? '+' : '' %>K<%= number_with_precision(change, precision: 2) %>
                      (<%= change_percentage >= 0 ? '+' : '' %><%= number_with_precision(change_percentage, precision: 2) %>%)
                    </div>
                  <% else %>
                    <div class="text-sm text-gray-500">-</div>
                  <% end %>
                </td>
              </tr>
              <% previous_value = entry['value'] %>
            <% end %>
          </tbody>
        </table>
      </div>
    <% else %>
      <div class="text-center py-8 bg-gray-50 rounded-lg">
        <p class="text-gray-500">No value history available yet. Update the investment value to start tracking.</p>
      </div>
    <% end %>
  </div>
  
  <!-- Recent Transactions -->
  <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
    <div class="flex justify-between items-center mb-4">
      <h2 class="text-lg font-semibold">Recent Transactions</h2>
      <%= link_to "View All Transactions", investment_investment_transactions_path(@investment), class: "text-blue-600 hover:text-blue-800" %>
    </div>
    
    <% if @transactions.any? %>
      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Amount</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Description</th>
            </tr>
          </thead>
          <tbody class="bg-white divide-y divide-gray-200">
            <% @transactions.each do |transaction| %>
              <tr class="hover:bg-gray-50">
                <td class="px-6 py-4 whitespace-nowrap">
                  <div class="text-sm text-gray-900"><%= transaction.transaction_date.strftime('%b %d, %Y') %></div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                  <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full 
                    <%= case transaction.transaction_type
                        when 'contribution' then 'bg-green-100 text-green-800'
                        when 'withdrawal' then 'bg-red-100 text-red-800'
                        when 'dividend', 'interest' then 'bg-blue-100 text-blue-800'
                        when 'fee' then 'bg-yellow-100 text-yellow-800'
                        end %>">
                    <%= transaction.transaction_type_text %>
                  </span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                  <div class="text-sm font-medium <%= ['withdrawal', 'fee'].include?(transaction.transaction_type) ? 'text-red-600' : 'text-green-600' %>">
                    <%= ['withdrawal', 'fee'].include?(transaction.transaction_type) ? '-' : '+' %>
                    K<%= number_with_precision(transaction.amount, precision: 2) %>
                  </div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                  <div class="text-sm text-gray-900"><%= transaction.description.present? ? transaction.description : '-' %></div>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    <% else %>
      <div class="text-center py-4 bg-gray-50 rounded-lg">
        <p class="text-gray-500">No transactions recorded yet.</p>
        <%= link_to "Add Transaction", new_investment_investment_transaction_path(@investment), class: "text-blue-600 hover:text-blue-800" %>
      </div>
    <% end %>
  </div>
  
  <!-- Investment Details -->
  <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
    <h2 class="text-lg font-semibold mb-4">Investment Details</h2>
    
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <div>
        <p class="text-sm text-gray-600 mb-1">Start Date</p>
        <p class="text-lg font-medium">
          <%= @investment.start_date ? @investment.start_date.strftime('%B %d, %Y') : 'Not specified' %>
        </p>
      </div>
      
      <div>
        <p class="text-sm text-gray-600 mb-1">Target Date</p>
        <p class="text-lg font-medium">
          <%= @investment.target_date ? @investment.target_date.strftime('%B %d, %Y') : 'Not specified' %>
        </p>
      </div>
      
      <div>
        <p class="text-sm text-gray-600 mb-1">Target Value</p>
        <p class="text-lg font-medium">
          <%= @investment.target_value ? "K#{number_with_precision(@investment.target_value, precision: 2)}" : 'Not specified' %>
        </p>
      </div>
      
      <div>
        <p class="text-sm text-gray-600 mb-1">Account Number</p>
        <p class="text-lg font-medium">
          <%= @investment.account_number.present? ? @investment.account_number : 'Not specified' %>
        </p>
      </div>
    </div>
    
    <% if @investment.notes.present? %>
      <div class="mt-6">
        <p class="text-sm text-gray-600 mb-1">Notes</p>
        <p class="text-lg"><%= @investment.notes %></p>
      </div>
    <% end %>
  </div>
  
  <!-- Action Buttons -->
  <div class="mt-6 flex justify-between">
    <%= link_to "Back to Investments", investments_path, class: "bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700" %>
    
    <div class="space-x-2">
      <%= link_to "Add Transaction", new_investment_investment_transaction_path(@investment), class: "bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700" %>
      <%= link_to "Edit Investment", edit_investment_path(@investment), class: "bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700" %>
      <%= button_to "Delete Investment", investment_path(@investment), method: :delete, data: { turbo_confirm: "Are you sure you want to delete this investment? This will also delete all associated transactions." }, class: "bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700" %>
    </div>
  </div>
</div>
