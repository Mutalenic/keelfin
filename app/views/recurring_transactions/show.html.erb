<nav class="flex justify-center align-center space-x-4 bg-[#3778c2] text-white">
  <ul class="w-full flex flex-row justify-between align-center p-5">
    <li>
      <%= link_to '', recurring_transactions_path, class: "text-xl fa-solid fa-arrow-left" %>
    </li>
    <li>
      <h1 class="text-xl uppercase">Recurring Transaction</h1>
    </li>
    <li>
      <%= link_to '', edit_recurring_transaction_path(@recurring_transaction), class: "text-xl fa-solid fa-pencil" %>
    </li>
  </ul>
</nav>

<div class="container mx-auto px-4 py-6">
  <!-- Transaction Details -->
  <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
    <div class="flex justify-between items-start">
      <div>
        <h1 class="text-2xl font-bold mb-2"><%= @recurring_transaction.name %></h1>
        <div class="mt-3 flex flex-wrap gap-2">
          <span class="inline-block px-3 py-1 rounded-full text-sm font-semibold bg-blue-100 text-blue-800">
            <%= @recurring_transaction.category.name %>
          </span>
          <span class="inline-block px-3 py-1 rounded-full text-sm font-semibold <%= @recurring_transaction.is_essential ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800' %>">
            <%= @recurring_transaction.is_essential ? 'Essential' : 'Non-essential' %>
          </span>
          <% if @recurring_transaction.payment_method.present? %>
            <span class="inline-block px-3 py-1 rounded-full text-sm font-semibold bg-gray-100 text-gray-800">
              <%= @recurring_transaction.payment_method.titleize %>
            </span>
          <% end %>
        </div>
      </div>
      <div class="text-right">
        <% if @recurring_transaction.active? %>
          <span class="inline-block px-4 py-2 rounded-lg text-sm font-bold bg-green-100 text-green-800">
            Active
          </span>
        <% else %>
          <span class="inline-block px-4 py-2 rounded-lg text-sm font-bold bg-gray-100 text-gray-800">
            Inactive
          </span>
        <% end %>
      </div>
    </div>
    
    <div class="mt-6 grid grid-cols-1 md:grid-cols-3 gap-6">
      <div class="bg-gray-50 rounded-lg p-4">
        <p class="text-sm text-gray-600 mb-1">Amount</p>
        <p class="text-2xl font-bold">K<%= number_with_precision(@recurring_transaction.amount, precision: 2) %></p>
      </div>
      
      <div class="bg-gray-50 rounded-lg p-4">
        <p class="text-sm text-gray-600 mb-1">Frequency</p>
        <p class="text-2xl font-bold"><%= @recurring_transaction.human_readable_frequency %></p>
      </div>
      
      <div class="bg-gray-50 rounded-lg p-4">
        <p class="text-sm text-gray-600 mb-1">Monthly Impact</p>
        <p class="text-2xl font-bold">K<%= number_with_precision(@recurring_transaction.estimated_monthly_impact, precision: 2) %></p>
      </div>
    </div>
    
    <div class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-6">
      <div>
        <p class="text-sm text-gray-600 mb-1">Start Date</p>
        <p class="text-lg font-medium"><%= @recurring_transaction.start_date.strftime('%B %d, %Y') %></p>
      </div>
      
      <div>
        <p class="text-sm text-gray-600 mb-1">End Date</p>
        <p class="text-lg font-medium">
          <% if @recurring_transaction.end_date %>
            <%= @recurring_transaction.end_date.strftime('%B %d, %Y') %>
          <% else %>
            No end date
          <% end %>
        </p>
      </div>
      
      <div>
        <p class="text-sm text-gray-600 mb-1">Next Occurrence</p>
        <p class="text-lg font-medium">
          <% if @recurring_transaction.next_occurrence %>
            <%= @recurring_transaction.next_occurrence.strftime('%B %d, %Y') %>
            <% days_until = (@recurring_transaction.next_occurrence - Date.current).to_i %>
            <span class="text-sm <%= days_until <= 0 ? 'text-red-600 font-bold' : 'text-gray-600' %>">
              (<%= days_until <= 0 ? 'Due today' : "in #{days_until} days" %>)
            </span>
          <% else %>
            Not scheduled
          <% end %>
        </p>
      </div>
      
      <div>
        <p class="text-sm text-gray-600 mb-1">Last Occurrence</p>
        <p class="text-lg font-medium">
          <% if @recurring_transaction.last_occurrence %>
            <%= @recurring_transaction.last_occurrence.strftime('%B %d, %Y') %>
          <% else %>
            Never processed
          <% end %>
        </p>
      </div>
    </div>
    
    <% if @recurring_transaction.notes.present? %>
      <div class="mt-6">
        <p class="text-sm text-gray-600 mb-1">Notes</p>
        <p class="text-lg"><%= @recurring_transaction.notes %></p>
      </div>
    <% end %>
  </div>
  
  <!-- Payment History -->
  <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
    <h2 class="text-xl font-semibold mb-4">Payment History</h2>
    
    <% if @payment_history.any? %>
      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Amount</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Payment Method</th>
            </tr>
          </thead>
          <tbody class="bg-white divide-y divide-gray-200">
            <% @payment_history.each do |payment| %>
              <tr class="hover:bg-gray-50">
                <td class="px-6 py-4 whitespace-nowrap">
                  <div class="text-sm text-gray-900"><%= payment.created_at.strftime('%b %d, %Y') %></div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                  <div class="text-sm font-medium text-gray-900"><%= payment.name %></div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                  <div class="text-sm font-medium">K<%= number_with_precision(payment.amount, precision: 2) %></div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                  <div class="text-sm text-gray-900"><%= payment.payment_method.present? ? payment.payment_method.titleize : 'N/A' %></div>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    <% else %>
      <p class="text-gray-500 italic">No payment history found for this recurring transaction.</p>
    <% end %>
  </div>
  
  <!-- Financial Impact -->
  <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
    <h2 class="text-xl font-semibold mb-4">Financial Impact</h2>
    
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <div class="bg-gray-50 rounded-lg p-4">
        <p class="text-sm text-gray-600 mb-1">Monthly Impact</p>
        <p class="text-2xl font-bold">K<%= number_with_precision(@recurring_transaction.estimated_monthly_impact, precision: 2) %></p>
        <p class="text-sm text-gray-600 mt-2">This is approximately <%= ((@recurring_transaction.estimated_monthly_impact / current_user.monthly_income) * 100).round(1) %>% of your monthly income.</p>
      </div>
      
      <div class="bg-gray-50 rounded-lg p-4">
        <p class="text-sm text-gray-600 mb-1">Annual Impact</p>
        <p class="text-2xl font-bold">K<%= number_with_precision(@recurring_transaction.estimated_monthly_impact * 12, precision: 2) %></p>
      </div>
    </div>
    
    <div class="mt-6 bg-blue-50 border border-blue-200 rounded-lg p-4">
      <div class="flex items-center">
        <div class="mr-4 text-blue-500">
          <i class="fa-solid fa-lightbulb text-2xl"></i>
        </div>
        <div>
          <p class="font-medium">Financial Insight</p>
          <% if @recurring_transaction.is_essential %>
            <p class="text-sm">This is marked as an essential expense. Consider if there are ways to reduce this recurring cost while maintaining the service.</p>
          <% else %>
            <p class="text-sm">This is a non-essential expense. If you're looking to save money, consider if this recurring payment is bringing enough value.</p>
          <% end %>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Action Buttons -->
  <div class="mt-6 flex justify-between">
    <%= link_to "Back to Recurring Transactions", recurring_transactions_path, class: "bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700" %>
    
    <div class="space-x-2">
      <% if @recurring_transaction.active? %>
        <%= button_to "Pause Transaction", toggle_active_recurring_transaction_path(@recurring_transaction), method: :patch, class: "bg-yellow-600 text-white px-4 py-2 rounded-lg hover:bg-yellow-700" %>
      <% else %>
        <%= button_to "Activate Transaction", toggle_active_recurring_transaction_path(@recurring_transaction), method: :patch, class: "bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700" %>
      <% end %>
      
      <%= link_to "Edit Transaction", edit_recurring_transaction_path(@recurring_transaction), class: "bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700" %>
      <%= button_to "Delete Transaction", recurring_transaction_path(@recurring_transaction), method: :delete, data: { turbo_confirm: "Are you sure you want to delete this recurring transaction?" }, class: "bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700" %>
    </div>
  </div>
</div>
